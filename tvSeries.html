<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>TVTRACKER - Gestione Serie TV</title>
    <style>
      :root {
        --bg: #0d0d0d;
        --bg-soft: #1a1a1a;
        --accent: #e50914;
        --accent-hover: #ff1a25;
        --accent-glow: rgba(229, 9, 20, 0.3);
        --text: #ffffff;
        --text-muted: #b3b3b3;
        --radius: 12px;
        --radius-sm: 8px;
        --shadow: 0 6px 20px rgba(0, 0, 0, 0.45);
        --shadow-hover: 0 12px 28px rgba(0, 0, 0, 0.6);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      body {
        background: var(--bg);
        color: var(--text);
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 50px;
        flex-wrap: wrap;
        gap: 24px;
        padding: 20px 25px;
        background: linear-gradient(135deg, #141414 0%, #1a1a1a 100%);
        border-radius: var(--radius);
        border: 1px solid #2a2a2a;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }

      .top-bar::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent), #ff6b6b);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0%,
        100% {
          background-position: -200% 0;
        }
        50% {
          background-position: 200% 0;
        }
      }

      .top-bar-left {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .logo {
        font-size: 36px;
        font-weight: 900;
        color: var(--accent);
        letter-spacing: -0.5px;
        text-shadow: 0 2px 10px var(--accent-glow);
        position: relative;
        display: inline-block;
        transition: var(--transition);
      }

      .logo:hover {
        transform: translateY(-2px);
        text-shadow: 0 4px 20px var(--accent-glow);
      }

      .subtitle {
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 500;
      }

      .button-group {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: var(--radius-sm);
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-height: 40px;
      }

      .btn::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
      }

      .btn:focus:not(:active)::after {
        animation: ripple 0.6s ease-out;
      }

      @keyframes ripple {
        0% {
          transform: scale(0, 0);
          opacity: 0.5;
        }
        20% {
          transform: scale(25, 25);
          opacity: 0.3;
        }
        100% {
          opacity: 0;
          transform: scale(40, 40);
        }
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent) 0%, #c40812 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(229, 9, 20, 0.25);
      }

      .btn-primary:hover {
        background: linear-gradient(
          135deg,
          var(--accent-hover) 0%,
          #d40913 100%
        );
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(229, 9, 20, 0.4);
      }

      .btn-primary:active {
        transform: translateY(0);
        transition: all 0.1s ease;
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }

      .btn-icon {
        width: 16px;
        height: 16px;
        opacity: 0.9;
      }

      .add-category-form {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .input-group {
        position: relative;
        display: flex;
        align-items: center;
      }

      .input-icon {
        position: absolute;
        left: 14px;
        color: var(--text-muted);
        pointer-events: none;
      }

      .form-input {
        padding: 12px 16px 12px 42px;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-size: 14px;
        min-width: 280px;
        transition: var(--transition);
        backdrop-filter: blur(10px);
      }

      .form-input:focus {
        outline: none;
        border-color: var(--accent);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 0 3px var(--accent-glow);
      }

      .form-input::placeholder {
        color: var(--text-muted);
      }

      .categories {
        display: flex;
        flex-direction: column;
        gap: 50px;
      }

      .category-title {
        font-size: 26px;
        font-weight: 700;
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .category-title::before {
        content: "";
        display: block;
        width: 4px;
        height: 24px;
        background: var(--accent);
        border-radius: 2px;
      }

      .shows-row {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 18px;
      }

      .show-card {
        background: var(--bg-soft);
        border-radius: var(--radius);
        overflow: hidden;
        cursor: grab;
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: relative;
      }

      .show-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), transparent);
        opacity: 0;
        transition: var(--transition);
      }

      .show-card:hover {
        transform: translateY(-6px);
        box-shadow: var(--shadow-hover);
      }

      .show-card:hover::before {
        opacity: 1;
      }

      .show-card.dragging {
        opacity: 0.5;
        transform: scale(0.95);
        box-shadow: 0 0 0 2px var(--accent);
      }

      .poster {
        width: 100%;
        height: 220px;
        object-fit: cover;
        background: linear-gradient(135deg, #222 0%, #2a2a2a 100%);
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .poster:hover {
        transform: scale(1.05);
      }

      .show-info {
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .show-number {
        font-size: 12px;
        color: var(--text-muted);
        font-weight: 600;
      }

      .show-title {
        font-size: 15px;
        font-weight: 600;
        line-height: 1.3;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      .show-title:hover {
        color: var(--accent);
      }

      .show-progress {
        font-size: 13px;
        color: var(--accent);
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .show-progress::before {
        content: "●";
        font-size: 8px;
      }

      .add-show-form {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .add-show-form input {
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-sm);
        color: var(--text);
        font-size: 14px;
        transition: var(--transition);
      }

      .add-show-form input:focus {
        outline: none;
        border-color: var(--accent);
        background: rgba(255, 255, 255, 0.08);
      }

      .empty-msg {
        padding: 30px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--radius);
        text-align: center;
        color: var(--text-muted);
        border: 2px dashed rgba(255, 255, 255, 0.1);
        grid-column: 1 / -1;
      }

      .drop-hint {
        font-size: 12px;
        color: var(--text-muted);
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .drop-hint::before {
        content: "↕";
        display: inline-block;
        animation: bounce 2s infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
      }

      /* MODAL STYLES */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
        border-radius: var(--radius);
        max-width: 900px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid #2a2a2a;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .modal-header {
        padding: 25px 30px 15px;
        border-bottom: 1px solid #2a2a2a;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 28px;
        background: linear-gradient(90deg, var(--accent), #ff6b6b);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .modal-close {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 28px;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
      }

      .modal-close:hover {
        color: var(--accent);
        background: rgba(229, 9, 20, 0.1);
      }

      .modal-body {
        padding: 30px;
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 30px;
      }

      .modal-poster {
        width: 100%;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        object-fit: cover;
        height: 450px;
      }

      .modal-details {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .detail-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .detail-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 10px 15px;
        border-radius: var(--radius-sm);
        border-left: 3px solid var(--accent);
      }

      .detail-item h4 {
        margin: 0 0 5px 0;
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .detail-item p {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }

      .overview {
        line-height: 1.6;
        color: var(--text-muted);
      }

      .seasons-episodes {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }

      .season-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 10px;
        border-radius: var(--radius-sm);
        text-align: center;
        border: 1px solid transparent;
        transition: var(--transition);
      }

      .season-item:hover {
        border-color: var(--accent);
        background: rgba(229, 9, 20, 0.05);
      }

      .season-item h5 {
        margin: 0 0 5px 0;
        font-size: 14px;
        color: var(--text);
      }

      .season-item p {
        margin: 0;
        font-size: 12px;
        color: var(--text-muted);
      }

      .modal-footer {
        padding: 20px 30px;
        border-top: 1px solid #2a2a2a;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .external-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--accent);
        text-decoration: none;
        font-weight: 600;
        padding: 10px 20px;
        border-radius: var(--radius-sm);
        background: rgba(229, 9, 20, 0.1);
        transition: var(--transition);
      }

      .external-link:hover {
        background: rgba(229, 9, 20, 0.2);
        transform: translateY(-2px);
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
      }

      .loading::after {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid var(--accent);
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* TOGGLE CONTAINER - VERSIONE MIGLIORATA */
      .toggle-container {
        margin-bottom: 30px;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background: linear-gradient(
          135deg,
          rgba(229, 9, 20, 0.1) 0%,
          rgba(148, 27, 33, 0.05) 100%
        );
        border-radius: var(--radius);
        border: 1px solid rgba(229, 9, 20, 0.2);
        box-shadow:
          0 8px 32px rgba(229, 9, 20, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        position: relative;
        overflow: hidden;
        transition: var(--transition);
      }

      .toggle-container:hover {
        border-color: rgba(229, 9, 20, 0.3);
        box-shadow:
          0 12px 40px rgba(229, 9, 20, 0.15),
          inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }

      .toggle-left {
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1;
      }

      .toggle-icon {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          135deg,
          rgba(229, 9, 20, 0.2) 0%,
          rgba(148, 27, 33, 0.15) 100%
        );
        border: 1px solid rgba(229, 9, 20, 0.3);
        color: var(--accent);
        font-size: 20px;
        box-shadow: 0 4px 12px rgba(229, 9, 20, 0.15);
      }

      .toggle-text {
        flex: 1;
      }

      .toggle-title {
        font-size: 16px;
        font-weight: 700;
        color: white;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toggle-description {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.5;
        max-width: 400px;
      }

      .toggle-right {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-shrink: 0;
      }

      /* Modern switch design */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 68px;
        height: 36px;
        flex-shrink: 0;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.05) 100%
        );
        border: 2px solid rgba(255, 255, 255, 0.15);
        transition: var(--transition);
        border-radius: 34px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 28px;
        width: 28px;
        left: 4px;
        top: 4px;
        background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
        transition: var(--transition);
        border-radius: 50%;
        box-shadow:
          0 3px 6px rgba(0, 0, 0, 0.2),
          0 0 10px rgba(229, 9, 20, 0.4);
      }

      input:checked + .toggle-slider {
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          #c40812 100%
        );
        border-color: rgba(229, 9, 20, 0.6);
      }

      input:checked + .toggle-slider:before {
        transform: translateX(32px);
        box-shadow:
          0 3px 6px rgba(0, 0, 0, 0.3),
          0 0 15px rgba(229, 9, 20, 0.6);
      }

      /* Status badge */
      .toggle-status {
        font-size: 12px;
        font-weight: 800;
        padding: 8px 16px;
        border-radius: 20px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.05) 100%
        );
        border: 1px solid rgba(255, 255, 255, 0.15);
        min-width: 85px;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: rgba(255, 255, 255, 0.8);
        transition: var(--transition);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      input:checked ~ .toggle-status,
      input:checked + .toggle-slider ~ .toggle-status {
        background: linear-gradient(
          135deg,
          rgba(229, 9, 20, 0.3) 0%,
          rgba(148, 27, 33, 0.2) 100%
        );
        border-color: rgba(229, 9, 20, 0.5);
        color: white;
        box-shadow: 0 2px 12px rgba(229, 9, 20, 0.3);
        text-shadow: 0 0 8px rgba(229, 9, 20, 0.5);
      }

      /* STATISTICHE PRINCIPALI - GRIGLIA MIGLIORATA */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          rgba(229, 9, 20, 0.08) 0%,
          rgba(148, 27, 33, 0.04) 100%
        );
        border-radius: var(--radius);
        padding: 25px;
        text-align: center;
        border: 1px solid rgba(229, 9, 20, 0.15);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 180px;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), #ff6b6b);
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(229, 9, 20, 0.15);
        border-color: rgba(229, 9, 20, 0.25);
      }

      .stat-card h3 {
        margin: 0 0 15px 0;
        font-size: 14px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      /* NUMERI IN ROSSO - MIGLIORATI */
      .stat-value {
        font-size: 48px;
        font-weight: 900;
        color: var(--accent) !important;
        margin: 10px 0;
        line-height: 1;
        text-shadow: 0 3px 15px rgba(229, 9, 20, 0.4);
        font-family: 'Inter', sans-serif;
      }

      .stat-subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 12px;
        opacity: 0.9;
        max-width: 200px;
        line-height: 1.4;
      }

      /* STATISTICHE PER CATEGORIA - LAYOUT MIGLIORATO */
      .stats-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin: 30px 0;
      }

      @media (max-width: 1024px) {
        .stats-columns {
          grid-template-columns: 1fr;
        }
      }

      .stats-section {
        background: rgba(255, 255, 255, 0.02);
        border-radius: var(--radius);
        padding: 25px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .stats-section h3 {
        margin: 0 0 20px 0;
        color: white;
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(229, 9, 20, 0.3);
      }

      .stats-section h3 i {
        color: var(--accent);
        font-size: 16px;
      }

      /* LISTA CATEGORIE - LAYOUT TABELLARE */
      .categories-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .category-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        transition: var(--transition);
      }

      .category-item:hover {
        background: rgba(255, 255, 255, 0.04);
        transform: translateX(5px);
        border-color: rgba(229, 9, 20, 0.1);
      }

      .category-name {
        font-size: 15px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
        flex: 1;
      }

      .category-stats {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .category-stat {
        text-align: right;
        min-width: 100px;
      }

      .stat-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .stat-number {
        font-size: 18px;
        font-weight: 700;
        color: var(--accent);
      }

      /* SERIE PIÙ VISTE - LAYOUT MIGLIORATO */
      .top-shows-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .top-show-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        transition: var(--transition);
      }

      .top-show-item:hover {
        background: rgba(255, 255, 255, 0.04);
        transform: translateX(5px);
        border-color: rgba(229, 9, 20, 0.1);
      }

      .show-rank {
        width: 36px;
        height: 36px;
        flex-shrink: 0;
        background: linear-gradient(
          135deg,
          rgba(229, 9, 20, 0.2) 0%,
          rgba(148, 27, 33, 0.15) 100%
        );
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 800;
        color: var(--accent);
        border: 1px solid rgba(229, 9, 20, 0.3);
      }

      .show-info {
        flex: 1;
      }

      .show-title {
        font-size: 15px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 4px;
      }

      .show-category {
        font-size: 12px;
        color: var(--text-muted);
      }

      .show-views {
        font-size: 18px;
        font-weight: 700;
        color: var(--accent);
        min-width: 80px;
        text-align: right;
        text-shadow: 0 1px 3px rgba(229, 9, 20, 0.3);
      }

      .show-views-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 2px;
      }

      .card-menu {
        margin-left: auto;
        cursor: pointer;
        font-size: 18px;
        color: var(--text-muted);
        position: relative;
      }

      .card-menu-box {
        position: absolute;
        background: #222;
        border: 1px solid #333;
        padding: 6px;
        border-radius: 6px;
        margin-top: 4px;
        right: 0;
        z-index: 10;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .card-menu-box button {
        background: #333;
        border: none;
        padding: 6px 10px;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
      }

      .card-menu-box button:hover {
        background: #444;
      }

      .card-menu-box .delete-btn {
        background: #b30000;
      }

      .card-menu-box .delete-btn:hover {
        background: #e50914;
      }

      .dragging-category {
        opacity: 0.5;
        transform: scale(0.98);
      }

      .error-message {
        background: rgba(229, 9, 20, 0.1);
        border: 1px solid var(--accent);
        border-radius: var(--radius);
        padding: 15px;
        margin: 20px 0;
        color: var(--accent);
        text-align: center;
      }

      .error-message h3 {
        margin-top: 0;
        color: var(--accent);
      }

      .error-message code {
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 5px;
        border-radius: 4px;
        font-family: monospace;
      }

      /* RESPONSIVE IMPROVEMENTS */
      @media (max-width: 768px) {
        .toggle-container {
          flex-direction: column;
          align-items: stretch;
          gap: 15px;
        }

        .toggle-left {
          flex-direction: column;
          align-items: flex-start;
        }

        .toggle-right {
          width: 100%;
          justify-content: space-between;
        }

        .stats-grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .stat-card {
          padding: 20px;
          min-height: 160px;
        }

        .stat-value {
          font-size: 40px;
        }

        .categories-list,
        .top-shows-list {
          gap: 10px;
        }

        .category-item,
        .top-show-item {
          padding: 12px;
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .category-stats {
          width: 100%;
          justify-content: space-between;
        }

        .category-stat {
          text-align: center;
          min-width: auto;
        }

        .top-show-item {
          flex-direction: row;
          flex-wrap: wrap;
        }

        .show-views {
          text-align: left;
        }
      }

      @media (max-width: 1024px) {
        .top-bar {
          flex-direction: column;
          align-items: stretch;
        }

        .top-bar-left {
          align-items: center;
          text-align: center;
        }

        .add-category-form {
          flex-direction: column;
          align-items: stretch;
        }

        .form-input {
          min-width: auto;
          width: 100%;
        }

        .shows-row {
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }

        .modal-body {
          grid-template-columns: 1fr;
        }

        .modal-poster {
          height: 350px;
          max-width: 250px;
          margin: 0 auto;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 15px;
        }

        .shows-row {
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
          gap: 12px;
        }

        .btn {
          padding: 8px 16px;
          font-size: 13px;
        }

        .form-input {
          padding: 10px 14px 10px 38px;
        }

        .modal-content {
          max-height: 95vh;
        }

        .modal-body {
          padding: 20px;
          gap: 20px;
        }

        .modal-header {
          padding: 15px 20px;
        }

        .modal-header h2 {
          font-size: 22px;
        }

        .detail-row {
          flex-direction: column;
        }
      }
}
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="top-bar">
      <div class="top-bar-left">
        <div class="logo">TVTRACKER</div>
        <div class="subtitle">Gestisci le tue serie TV con drag & drop</div>
        <div class="button-group">
          <button class="btn btn-primary" id="printListBtn">
            <i class="fas fa-print btn-icon"></i>
            Stampa lista
          </button>
          <button class="btn btn-secondary" id="statsBtn">
            <i class="fas fa-chart-bar btn-icon"></i>
            Statistiche
          </button>
          <button
            class="btn btn-secondary"
            id="resetBtn"
            title="Ripristina dati originali"
          >
            <i class="fas fa-redo btn-icon"></i>
            Reset
          </button>
          <button
            class="btn btn-secondary"
            id="checkJsonBtn"
            title="Verifica file JSON"
          >
            <i class="fas fa-code btn-icon"></i>
            Verifica JSON
          </button>
        </div>
      </div>

      <form class="add-category-form" id="addCategoryForm">
        <div class="input-group">
          <i class="fas fa-plus input-icon"></i>
          <input
            type="text"
            id="newCategoryName"
            class="form-input"
            placeholder="Nome nuova categoria..."
            autocomplete="off"
          />
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-folder-plus btn-icon"></i>
          Aggiungi
        </button>
      </form>
    </div>

    <div id="errorContainer"></div>
    <div class="categories" id="categoriesContainer"></div>

    <script>
      // ---------------- SISTEMA DI CARICAMENTO DATI ----------------
      let data = [];

      // Funzione per caricare dati dal localStorage
      function loadData() {
        const saved = localStorage.getItem("tvtracker-data");
        if (saved) {
          try {
            return JSON.parse(saved);
          } catch (e) {
            console.error("Errore nel parsing dei dati salvati:", e);
            showError("Errore nel caricamento dei dati salvati: " + e.message);
          }
        }
        return null;
      }

      // Funzione per caricare dati di default dal file JSON con validazione migliore
      async function loadDefaultData() {
        try {
          const response = await fetch("./data/default-data.json");
          if (!response.ok) {
            throw new Error(
              `Errore HTTP! Status: ${response.status} - ${response.statusText}`,
            );
          }

          const text = await response.text();

          // Pulisci il testo JSON (rimuovi BOM se presente)
          const cleanedText = text.replace(/^\uFEFF/, "");

          try {
            const defaultData = JSON.parse(cleanedText);

            // Controlla che i dati siano un array valido
            if (!Array.isArray(defaultData)) {
              throw new Error(
                "Il file default-data.json non contiene un array valido.",
              );
            }

            // Valida la struttura di base
            for (const category of defaultData) {
              if (!category.name || typeof category.name !== "string") {
                throw new Error("Categoria senza nome o nome non valido");
              }
              if (!Array.isArray(category.shows)) {
                throw new Error(
                  `Categoria "${category.name}" non ha un array di show valido`,
                );
              }
            }

            console.log(
              "Dati caricati correttamente dal file JSON:",
              defaultData.length,
              "categorie",
            );
            return defaultData;
          } catch (parseError) {
            // Tenta di trovare l'errore di sintassi
            const lines = cleanedText.split("\n");
            let lineNumber = 1;
            let charCount = 0;

            for (let i = 0; i < lines.length; i++) {
              charCount += lines[i].length + 1; // +1 per il newline
              if (charCount >= 4210) {
                // Posizione dell'errore dal messaggio
                lineNumber = i + 1;
                break;
              }
            }

            throw new Error(
              `Errore di sintassi JSON alla riga ${lineNumber}, posizione ${4210}. Controlla che non manchino virgole o che non ci siano errori di formattazione. Dettaglio: ${parseError.message}`,
            );
          }
        } catch (error) {
          console.error(
            "Errore nel caricamento del file default-data.json:",
            error,
          );

          // Crea un messaggio di errore dettagliato
          const errorMessage = `
      <div class="error-message">
        <h3><i class="fas fa-exclamation-triangle"></i> Errore nel caricamento del file JSON</h3>
        <p><strong>${error.message}</strong></p>
        <p>Il file <code>data/default-data.json</code> contiene un errore di sintassi.</p>
        <p>Controlla:</p>
        <ul>
          <li>Che tutte le virgole siano presenti tra gli elementi degli array</li>
          <li>Che tutte le parentesi siano chiuse correttamente</li>
          <li>Che non ci siano errori di formattazione</li>
        </ul>
        <p>Puoi usare uno strumento online come <a href="https://jsonlint.com/" target="_blank" style="color: var(--accent);">JSONLint</a> per validare il tuo file.</p>
        <p><small>L'app utilizzerà i dati dal localStorage se disponibili, altrimenti partirà vuota.</small></p>
      </div>
    `;

          document.getElementById("errorContainer").innerHTML = errorMessage;
          return [];
        }
      }

      // Funzione per mostrare errori
      function showError(message) {
        const errorContainer = document.getElementById("errorContainer");
        errorContainer.innerHTML = `
    <div class="error-message">
      <h3><i class="fas fa-exclamation-triangle"></i> Errore</h3>
      <p>${message}</p>
    </div>
  `;
      }

      // Funzione per salvare dati nel localStorage
      function saveData() {
        localStorage.setItem("tvtracker-data", JSON.stringify(data));
      }

      // Funzione per inizializzare i dati
      async function initData() {
        // Prima controlla se ci sono dati nel localStorage
        const savedData = loadData();
        if (savedData && Array.isArray(savedData) && savedData.length > 0) {
          data = savedData;
          console.log(
            "Dati caricati dal localStorage:",
            data.length,
            "categorie",
          );
        } else {
          // Se non ci sono dati salvati, carica i dati di default dal file JSON
          data = await loadDefaultData();
          // E salvali nel localStorage per la prossima volta
          if (data.length > 0) {
            saveData();
            console.log("Dati di default salvati nel localStorage");
          }
        }
      }

      // ---------------- PULSANTE VERIFICA JSON ----------------
      document
        .getElementById("checkJsonBtn")
        .addEventListener("click", async () => {
          try {
            const response = await fetch("./data/default-data.json");
            const text = await response.text();
            const cleanedText = text.replace(/^\uFEFF/, "");

            // Prova a parsare il JSON
            JSON.parse(cleanedText);

            alert("✅ Il file JSON è valido!");
          } catch (error) {
            showError(`Errore di validazione JSON: ${error.message}`);
          }
        });

      // ---------------- PULSANTE STATISTICHE ----------------
      document
        .getElementById("statsBtn")
        .addEventListener("click", showStatistics);

      function showStatistics() {
        // Impostazione iniziale: NON escludere la categoria "Da vedere in futuro" (default)
        let excludeFutureCategory = false;

        // Crea il modal delle statistiche
        const modalOverlay = document.createElement("div");
        modalOverlay.className = "modal-overlay";

        const modalContent = document.createElement("div");
        modalContent.className = "modal-content";
        modalContent.style.maxWidth = "1000px";

        function updateStatisticsContent() {
          // Calcola le statistiche
          const stats = calculateStatistics(excludeFutureCategory);

          modalContent.innerHTML = `
<div class="modal-header">
  <h2><i class="fas fa-chart-bar" aria-hidden="true"></i> Statistiche Serie TV</h2>
  <button class="modal-close" aria-label="Chiudi finestra">&times;</button>
</div>

<div class="modal-body">
  <!-- Toggle Container - RIMOSSA LA SEZIONE ESCLUSE -->
  <div class="toggle-container" role="group" aria-label="Filtro categorie">
    <div class="toggle-left">
      <div class="toggle-icon">
        <i class="fas fa-filter"></i>
      </div>
      <div class="toggle-text">
        <div class="toggle-title">
          <span>Includi "Da vedere in futuro"</span>
        </div>
        <div class="toggle-description">
          ${excludeFutureCategory
            ? "Le serie nella categoria 'Da vedere in futuro' sono escluse dalle statistiche"
            : "Tutte le serie sono incluse nelle statistiche"}
        </div>
      </div>
    </div>
    
    <div class="toggle-right">
      <div class="toggle-switch">
        <input type="checkbox" id="excludeFutureToggle" ${excludeFutureCategory ? "checked" : ""}>
        <label for="excludeFutureToggle" class="toggle-slider" aria-hidden="true"></label>
      </div>
      <div class="toggle-status" aria-live="polite">
        ${excludeFutureCategory ? "ESCLUSE" : "TUTTE"}
      </div>
    </div>
  </div>

  <!-- Statistiche Principali -->
  <div class="stats-grid" role="status" aria-label="Statistiche principali">
    <div class="stat-card">
      <h3>Serie Totali</h3>
      <p class="stat-value">${stats.totalShows}</p>
      <p class="stat-subtitle">${excludeFutureCategory ? 'Senza "Da vedere in futuro"' : "Incluse tutte le categorie"}</p>
    </div>

    <div class="stat-card">
      <h3>Visioni Totali</h3>
      <p class="stat-value">${stats.totalViews}</p>
      <p class="stat-subtitle">Somma di tutte le visioni</p>
    </div>

    <div class="stat-card">
      <h3>Media Visioni</h3>
      <p class="stat-value">${stats.averageViews.toFixed(1)}</p>
      <p class="stat-subtitle">Visioni medie per serie</p>
    </div>

    <div class="stat-card">
      <h3>Categorie</h3>
      <p class="stat-value">${stats.totalCategories}</p>
      <p class="stat-subtitle">Categorie incluse</p>
    </div>
  </div>

  <!-- Statistiche Dettagliate -->
  <div class="stats-columns">
    <!-- Statistiche per Categoria -->
    <div class="stats-section">
      <h3><i class="fas fa-folder"></i> Statistiche per Categoria</h3>
      <div class="categories-list">
        ${stats.categories
          .map(
            (cat) => `
          <div class="category-item">
            <div class="category-name">${escapeHtml(cat.name)}</div>
            <div class="category-stats">
              <div class="category-stat">
                <div class="stat-label">Serie</div>
                <div class="stat-number">${cat.showCount}</div>
              </div>
              <div class="category-stat">
                <div class="stat-label">Visioni</div>
                <div class="stat-number">${cat.totalViews}</div>
              </div>
            </div>
          </div>
        `
          )
          .join("")}
      </div>
    </div>

    <!-- Serie Più Viste -->
    <div class="stats-section">
      <h3><i class="fas fa-trophy"></i> Serie Più Viste</h3>
      <div class="top-shows-list">
        ${stats.mostWatched
          .slice(0, 8)
          .map(
            (show, index) => `
          <div class="top-show-item">
            <div class="show-rank">${index + 1}</div>
            <div class="show-info">
              <div class="show-title">${escapeHtml(show.title)}</div>
              <div class="show-category">${escapeHtml(show.category)}</div>
            </div>
            <div>
              <div class="show-views">${show.views}</div>
              <div class="show-views-label">visioni</div>
            </div>
          </div>
        `
          )
          .join("")}
      </div>
    </div>
  </div>

  <!-- NOTA: RIMOSSA LA SEZIONE "SERIE ESCLUSE" PER EVITARE SOVRAPPOSIZIONI -->
</div>

<div class="modal-footer">
  <button class="btn btn-primary" id="closeStats">Chiudi Statistiche</button>
</div>
    `;

          // Aggiungi event listener per il toggle
          const toggle = modalContent.querySelector("#excludeFutureToggle");
          if (toggle) {
            toggle.addEventListener("change", function () {
              excludeFutureCategory = this.checked;
              updateStatisticsContent();
            });
          }

          // Gestione chiusura modal
          const closeBtn = modalContent.querySelector(".modal-close");
          const closeBtn2 = modalContent.querySelector("#closeStats");

          function closeModal() {
            modalOverlay.remove();
          }

          closeBtn.addEventListener("click", closeModal);
          closeBtn2.addEventListener("click", closeModal);
        }

        // Aggiorna il contenuto iniziale
        updateStatisticsContent();

        modalOverlay.appendChild(modalContent);
        document.body.appendChild(modalOverlay);

        // Gestione chiusura modal cliccando fuori
        modalOverlay.addEventListener("click", (e) => {
          if (e.target === modalOverlay) {
            modalOverlay.remove();
          }
        });

        // Tasto ESC per chiudere
        document.addEventListener("keydown", function closeOnEsc(e) {
          if (e.key === "Escape") {
            modalOverlay.remove();
            document.removeEventListener("keydown", closeOnEsc);
          }
        });
      }

      function calculateStatistics(excludeFutureCategory = false) {
        let totalShows = 0;
        let totalViews = 0;
        const categories = [];
        const mostWatched = [];
        let excludedShowsCount = 0; // Contatore per le serie escluse (solo per debug)

        // Calcola per ogni categoria
        data.forEach((category) => {
          let categoryShows = 0;
          let categoryViews = 0;
          const isFutureCategory =
            category.name.toLowerCase().includes("da vedere in futuro") ||
            category.name.toLowerCase().includes("da vedere") ||
            category.name.toLowerCase().includes("future");

          category.shows.forEach((show) => {
            categoryShows++;
            totalShows++;

            // Calcola le visioni (considera anche le revisioni)
            let views = 1; // Default a 1 se non specificato

            if (
              show.progress !== undefined &&
              show.progress !== null &&
              String(show.progress).trim() !== ""
            ) {
              // Gestisce diversi formati: "2", "2.5", "2,5", "3 volte", ecc.
              const progressStr = String(show.progress)
                .replace(",", ".")
                .trim();
              const match = progressStr.match(/[\d.]+/);
              if (match) {
                views = parseFloat(match[0]);
                if (isNaN(views)) {
                  views = 1; // Se il parsing fallisce, mantieni 1
                }
              }
            }

            // Se dobbiamo escludere la categoria "Da vedere in futuro" e questa è quella categoria
            if (excludeFutureCategory && isFutureCategory) {
              // Non contare le visioni di questa categoria
              excludedShowsCount++;
            } else {
              // Altrimenti, aggiungi al conteggio
              categoryViews += views;
              totalViews += views;

              // Aggiungi alla lista delle serie più viste
              mostWatched.push({
                title: show.title,
                views: views,
                category: category.name,
              });
            }
          });

          // Aggiungi la categoria solo se non è esclusa o se non stiamo escludendo
          if (!(excludeFutureCategory && isFutureCategory)) {
            categories.push({
              name: category.name,
              showCount: categoryShows,
              totalViews: categoryViews,
            });
          }
        });

        // Ordina le serie più viste (dalle più viste alle meno viste)
        mostWatched.sort((a, b) => b.views - a.views);

        // Se escludiamo la categoria "Da vedere in futuro", sottraiamo il conteggio
        const adjustedTotalShows = excludeFutureCategory
          ? totalShows - excludedShowsCount
          : totalShows;

        return {
          totalShows: adjustedTotalShows,
          totalViews: Math.round(totalViews * 10) / 10, // Arrotonda a 1 decimale
          averageViews: adjustedTotalShows > 0 ? totalViews / adjustedTotalShows : 0,
          totalCategories: categories.length,
          categories: categories,
          mostWatched,
        };
      }

      // ---------------- RESET ----------------
      document
        .getElementById("resetBtn")
        .addEventListener("click", async () => {
          if (
            confirm(
              "Vuoi davvero ripristinare i dati originali? I cambiamenti locali andranno persi.",
            )
          ) {
            // Rimuovi i dati dal localStorage
            localStorage.removeItem("tvtracker-data");

            // Pulisci eventuali errori precedenti
            document.getElementById("errorContainer").innerHTML = "";

            // Carica i dati di default dal file JSON
            data = await loadDefaultData();

            // Salva i dati di default nel localStorage
            saveData();

            // Rigenera l'interfaccia
            await render();

            // Feedback visivo
            const resetBtn = document.getElementById("resetBtn");
            const originalHtml = resetBtn.innerHTML;
            resetBtn.innerHTML =
              '<i class="fas fa-check btn-icon"></i> Ripristinato!';
            resetBtn.disabled = true;

            setTimeout(() => {
              resetBtn.innerHTML = originalHtml;
              resetBtn.disabled = false;
            }, 1500);
          }
        });

      // ---------------- RESTANTE CODICE ----------------
      const TMDB_API_KEY = "74f5aefb6bb96d044cbf995d9b1897e2";
      const TMDB_IMG = "https://image.tmdb.org/t/p/w342";
      const TMDB_IMG_LARGE = "https://image.tmdb.org/t/p/w780";
      const categoriesContainer = document.getElementById(
        "categoriesContainer",
      );
      let dragSrcEl = null;

      // Cache per i dettagli delle serie TV
      const showDetailsCache = {};

      // Funzione per ottenere i dettagli completi di una serie TV
      async function fetchShowDetails(title) {
        if (!title) return undefined;

        // Controlla cache
        if (showDetailsCache[title]) {
          return showDetailsCache[title];
        }

        try {
          const res = await fetch(
            `https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title)}&language=it-IT`,
          );

          if (!res.ok) return undefined;

          const json = await res.json();
          if (!json.results || !json.results.length) return undefined;

          // Prendi il primo risultato
          const result = json.results[0];

          // Ottieni dettagli più approfonditi (stagioni, ecc.)
          if (result.id) {
            const detailsRes = await fetch(
              `https://api.themoviedb.org/3/tv/${result.id}?api_key=${TMDB_API_KEY}&language=it-IT&append_to_response=credits`,
            );

            if (detailsRes.ok) {
              const details = await detailsRes.json();

              // Filtra e ordina le stagioni: escludi stagione 0 e ordina per season_number
              const filteredSeasons = (details.seasons || [])
                .filter((season) => season.season_number > 0)
                .sort((a, b) => a.season_number - b.season_number);

              // Calcola la data della prima stagione valida (non stagione 0)
              let firstValidAirDate = details.first_air_date;
              if (filteredSeasons.length > 0 && filteredSeasons[0].air_date) {
                firstValidAirDate = filteredSeasons[0].air_date;
              }

              const showDetails = {
                id: details.id,
                title: details.name,
                original_title: details.original_name,
                overview:
                  details.overview || "Nessuna descrizione disponibile.",
                poster_path: details.poster_path,
                backdrop_path: details.backdrop_path,
                vote_average: details.vote_average?.toFixed(1) || "N/A",
                first_air_date: firstValidAirDate || "Sconosciuta",
                number_of_seasons: filteredSeasons.length,
                number_of_episodes: details.number_of_episodes || 0,
                genres:
                  details.genres?.map((g) => g.name).join(", ") ||
                  "Nessun genere",
                seasons: filteredSeasons,
                status: details.status || "Sconosciuto",
                networks:
                  details.networks?.map((n) => n.name).join(", ") || "N/A",
              };

              // Salva in cache
              showDetailsCache[title] = showDetails;
              return showDetails;
            }
          }

          // Se non riesci a ottenere dettagli completi, usa almeno i dati base
          const basicDetails = {
            id: result.id,
            title: result.name,
            overview: result.overview || "Nessuna descrizione disponibile.",
            poster_path: result.poster_path,
            vote_average: result.vote_average?.toFixed(1) || "N/A",
            first_air_date: result.first_air_date || "Sconosciuta",
          };

          showDetailsCache[title] = basicDetails;
          return basicDetails;
        } catch (e) {
          console.warn("Errore fetchShowDetails:", e);
          return undefined;
        }
      }

      async function fetchPoster(title) {
        if (!title) return undefined;
        const endpoints = [`/search/tv`, `/search/movie`, `/search/multi`];
        for (const endpoint of endpoints) {
          try {
            const res = await fetch(
              `https://api.themoviedb.org/3${endpoint}?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title)}&language=it-IT`,
            );
            if (!res.ok) continue;
            const json = await res.json();
            if (!json.results || !json.results.length) continue;
            const found = json.results.find((r) => r.poster_path);
            if (found && found.poster_path) return TMDB_IMG + found.poster_path;
          } catch (e) {
            console.warn("Errore fetchPoster:", e);
          }
        }
        return undefined;
      }

      function createShowCard(title, progress, poster) {
        const card = document.createElement("div");
        card.className = "show-card";
        card.draggable = true;

        const img = document.createElement("img");
        img.className = "poster";
        img.src = poster || "https://via.placeholder.com/300x450?text=Poster";
        img.onerror = () => {
          console.warn("Poster non caricato:", img.src);
        };
        img.alt = title;
        img.loading = "lazy";

        // Aggiungi click al poster per aprire i dettagli
        img.addEventListener("click", (e) => {
          e.stopPropagation();
          openShowDetails(title);
        });

        const info = document.createElement("div");
        info.className = "show-info";

        const num = document.createElement("div");
        num.className = "show-number";
        num.textContent = "#";

        const titleEl = document.createElement("div");
        titleEl.className = "show-title";
        titleEl.textContent = title;

        // Aggiungi click al titolo per aprire i dettagli
        titleEl.addEventListener("click", (e) => {
          e.stopPropagation();
          openShowDetails(title);
        });

        const menu = document.createElement("div");
        menu.className = "card-menu";
        menu.innerHTML = "⋮";

        const menuBox = document.createElement("div");
        menuBox.className = "card-menu-box";
        menuBox.style.display = "none";

        menuBox.innerHTML = `
    <button class="details-btn"><i class="fas fa-info-circle"></i> Dettagli</button>
    <button class="edit-btn"><i class="fas fa-edit"></i> Modifica</button>
    <button class="delete-btn"><i class="fas fa-trash"></i> Elimina</button>
  `;

        menu.addEventListener("click", (e) => {
          e.stopPropagation();
          menuBox.style.display =
            menuBox.style.display === "none" ? "block" : "none";
        });

        // Chiudi il menu quando si clicca altrove
        document.addEventListener("click", (e) => {
          if (!menu.contains(e.target)) {
            menuBox.style.display = "none";
          }
        });

        menuBox.querySelector(".delete-btn").addEventListener("click", () => {
          deleteShow(title);
        });

        menuBox.querySelector(".edit-btn").addEventListener("click", () => {
          openEditPopup(title);
        });

        menuBox.querySelector(".details-btn").addEventListener("click", () => {
          openShowDetails(title);
          menuBox.style.display = "none";
        });

        info.appendChild(num);
        info.appendChild(titleEl);

        // SOLO SE progress è specificato E non è vuoto, mostra il contatore
        if (
          progress !== undefined &&
          progress !== null &&
          String(progress).trim() !== ""
        ) {
          const normalized = String(progress).replace(",", ".").trim();
          const progressEl = document.createElement("div");
          progressEl.className = "show-progress";

          // Se progress è 0, mostra "Da vedere" in grigio
          if (parseFloat(normalized) === 0) {
            progressEl.textContent = "Da vedere";
            progressEl.style.color = "#999";
          } else {
            progressEl.textContent = `Visto: ${normalized} volte`;
          }
          info.appendChild(progressEl);
        }

        info.appendChild(menu);
        info.appendChild(menuBox);

        card.appendChild(img);
        card.appendChild(info);

        // Aggiungi anche il doppio click sulla card intera
        card.addEventListener("dblclick", () => {
          openShowDetails(title);
        });

        addDragHandlers(card);
        return card;
      }

      // Funzione per aprire i dettagli della serie TV
      async function openShowDetails(title) {
        // Crea il modal
        const modalOverlay = document.createElement("div");
        modalOverlay.className = "modal-overlay";

        const modalContent = document.createElement("div");
        modalContent.className = "modal-content";

        modalContent.innerHTML = `
    <div class="modal-header">
      <h2>${escapeHtml(title)}</h2>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="loading">
        <p>Caricamento dettagli...</p>
      </div>
    </div>
  `;

        modalOverlay.appendChild(modalContent);
        document.body.appendChild(modalOverlay);

        // Gestione chiusura modal
        const closeBtn = modalContent.querySelector(".modal-close");
        closeBtn.addEventListener("click", () => {
          modalOverlay.remove();
        });

        modalOverlay.addEventListener("click", (e) => {
          if (e.target === modalOverlay) {
            modalOverlay.remove();
          }
        });

        // Tasto ESC per chiudere
        document.addEventListener("keydown", function closeOnEsc(e) {
          if (e.key === "Escape") {
            modalOverlay.remove();
            document.removeEventListener("keydown", closeOnEsc);
          }
        });

        // Carica i dettagli
        try {
          const details = await fetchShowDetails(title);

          if (!details) {
            modalContent.querySelector(".modal-body").innerHTML = `
        <div style="padding: 40px; text-align: center;">
          <p>Impossibile caricare i dettagli per "${escapeHtml(title)}"</p>
          <p><small>La serie potrebbe non essere presente nel database TMDB</small></p>
        </div>
      `;
            return;
          }

          // Trova il poster nella cache locale prima
          let posterUrl = TMDB_IMG_LARGE + details.poster_path;
          const localShow = data
            .flatMap((cat) => cat.shows)
            .find((s) => s.title === title);
          if (localShow?.poster) {
            posterUrl = localShow.poster.replace("/w342/", "/w780/");
          }

          // Crea HTML per le stagioni (solo stagioni > 0)
          let seasonsHTML = "";
          if (details.seasons && details.seasons.length > 0) {
            seasonsHTML = `
        <div class="detail-item" style="width: 100%;">
          <h4>Stagioni (${details.seasons.length})</h4>
          <div class="seasons-episodes">
            ${details.seasons
              .map(
                (season) => `
              <div class="season-item">
                <h5>Stagione ${season.season_number}</h5>
                <p>${season.episode_count} episodi</p>
                <small>${season.air_date ? season.air_date.substring(0, 4) : "N/A"}</small>
              </div>
            `,
              )
              .join("")}
          </div>
        </div>
      `;
          }

          modalContent.querySelector(".modal-body").innerHTML = `
      <img class="modal-poster" src="${posterUrl}" alt="${escapeHtml(details.title)}" onerror="this.src='https://via.placeholder.com/780x1170?text=Poster+Non+Disponibile'">
      <div class="modal-details">
        <div class="detail-row">
          <div class="detail-item">
            <h4>Voto Medio</h4>
            <p>${details.vote_average}/10</p>
          </div>
          <div class="detail-item">
            <h4>Prima TV</h4>
            <p>${details.first_air_date ? details.first_air_date.substring(0, 4) : "Sconosciuta"}</p>
          </div>
          <div class="detail-item">
            <h4>Stagioni</h4>
            <p>${details.number_of_seasons}</p>
          </div>
          <div class="detail-item">
            <h4>Episodi</h4>
            <p>${details.number_of_episodes}</p>
          </div>
        </div>
        
        <div class="detail-row">
          <div class="detail-item" style="width: 100%;">
            <h4>Genere</h4>
            <p>${details.genres}</p>
          </div>
        </div>
        
        <div class="detail-row">
          <div class="detail-item" style="width: 100%;">
            <h4>Stato</h4>
            <p>${details.status}</p>
          </div>
        </div>
        
        <div class="detail-row">
          <div class="detail-item" style="width: 100%;">
            <h4>Reti TV</h4>
            <p>${details.networks}</p>
          </div>
        </div>
        
        ${seasonsHTML}
        
        <div class="detail-row">
          <div class="detail-item" style="width: 100%;">
            <h4>Trama</h4>
            <p class="overview">${details.overview}</p>
          </div>
        </div>
      </div>
    `;

          // Aggiungi footer con link esterno
          const modalFooter = document.createElement("div");
          modalFooter.className = "modal-footer";

          const tmdbLink = document.createElement("a");
          tmdbLink.href = `https://www.themoviedb.org/tv/${details.id}`;
          tmdbLink.target = "_blank";
          tmdbLink.rel = "noopener noreferrer";
          tmdbLink.className = "external-link";
          tmdbLink.innerHTML =
            '<i class="fas fa-external-link-alt"></i> Vedi su TMDB';

          const closeButton = document.createElement("button");
          closeButton.className = "btn btn-primary";
          closeButton.textContent = "Chiudi";
          closeButton.addEventListener("click", () => {
            modalOverlay.remove();
          });

          modalFooter.appendChild(tmdbLink);
          modalFooter.appendChild(closeButton);

          modalContent.appendChild(modalFooter);
        } catch (error) {
          console.error("Errore nel caricamento dei dettagli:", error);
          modalContent.querySelector(".modal-body").innerHTML = `
      <div style="padding: 40px; text-align: center;">
        <p>Errore nel caricamento dei dettagli per "${escapeHtml(title)}"</p>
        <p><small>${error.message}</small></p>
      </div>
    `;
        }
      }

      function openEditPopup(oldTitle) {
        const cat = data.find((c) => c.shows.some((s) => s.title === oldTitle));
        if (!cat) return;
        const show = cat.shows.find((s) => s.title === oldTitle);

        const popup = document.createElement("div");
        popup.style.position = "fixed";
        popup.style.top = "0";
        popup.style.left = "0";
        popup.style.width = "100vw";
        popup.style.height = "100vh";
        popup.style.background = "rgba(0,0,0,0.85)";
        popup.style.display = "flex";
        popup.style.justifyContent = "center";
        popup.style.alignItems = "center";
        popup.style.zIndex = "9999";
        popup.style.padding = "20px";

        const box = document.createElement("div");
        box.style.background = "#111";
        box.style.padding = "20px";
        box.style.borderRadius = "8px";
        box.style.width = "90%";
        box.style.maxWidth = "400px";
        box.style.color = "#fff";
        box.style.display = "flex";
        box.style.flexDirection = "column";
        box.style.gap = "12px";

        box.innerHTML = `
    <h2>Modifica serie</h2>
    <label>Titolo</label>
    <input id="editTitle" type="text" value="${escapeHtml(show.title)}" />
    <label>Progresso (0 = da vedere, lascia vuoto se 1)</label>
    <input id="editProgress" type="text" value="${escapeHtml(show.progress || "")}" />
    <label>Poster URL</label>
    <input id="editPoster" type="text" value="${escapeHtml(show.poster || "")}" />
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button id="saveEdit" style="flex:1; background:#e50914; color:white; border:none; padding:8px; border-radius:4px;">Salva</button>
      <button id="cancelEdit" style="flex:1; background:#444; color:white; border:none; padding:8px; border-radius:4px;">Annulla</button>
    </div>
  `;

        popup.appendChild(box);
        document.body.appendChild(popup);

        document.getElementById("cancelEdit").onclick = () => popup.remove();

        document.getElementById("saveEdit").onclick = async () => {
          const newTitle = document.getElementById("editTitle").value.trim();
          let newProgress = document
            .getElementById("editProgress")
            .value.trim();
          const newPoster = document.getElementById("editPoster").value.trim();

          if (newProgress.includes(","))
            newProgress = newProgress.replace(",", ".");
          const matched = newProgress.match(/[\d.]+/);
          newProgress = matched
            ? matched[0]
            : newProgress
              ? newProgress
              : undefined;

          show.title = newTitle || show.title;
          show.progress = newProgress || undefined;
          show.poster = newPoster || undefined;

          // Invalida cache se il titolo è cambiato
          if (newTitle !== oldTitle && showDetailsCache[oldTitle]) {
            showDetailsCache[newTitle] = showDetailsCache[oldTitle];
            delete showDetailsCache[oldTitle];
          }

          saveData();
          await render();
          popup.remove();
        };
      }

      async function render() {
        categoriesContainer.innerHTML = "";

        if (data.length === 0) {
          const emptyMsg = document.createElement("div");
          emptyMsg.className = "empty-msg";
          emptyMsg.innerHTML = `
      <h3>Nessuna serie TV disponibile</h3>
      <p>Aggiungi delle serie manualmente o correggi il file <code>data/default-data.json</code></p>
      <p><small>Puoi usare il pulsante "Verifica JSON" per controllare la validità del file.</small></p>
    `;
          categoriesContainer.appendChild(emptyMsg);
          return;
        }

        for (let index = 0; index < data.length; index++) {
          const cat = data[index];
          const catEl = document.createElement("div");
          catEl.className = "category";
          catEl.draggable = true;
          catEl.dataset.index = index;
          addCategoryDragHandlers(catEl);

          const header = document.createElement("div");
          header.className = "category-header";

          const title = document.createElement("div");
          title.className = "category-title";
          title.textContent = cat.name;

          const actions = document.createElement("div");
          actions.className = "category-actions";
          const hint = document.createElement("small");
          hint.textContent = "Puoi trascinare le serie qui dentro";
          actions.appendChild(hint);

          header.appendChild(title);
          header.appendChild(actions);

          const row = document.createElement("div");
          row.className = "shows-row";
          row.dataset.categoryIndex = index;
          addDropHandlers(row);

          if (!cat.shows || !cat.shows.length) {
            row.classList.add("empty");
            const emptyMsg = document.createElement("div");
            emptyMsg.className = "empty-msg";
            emptyMsg.textContent = "Nessuna serie. Aggiungine una qui sotto.";
            row.appendChild(emptyMsg);
          } else {
            for (const show of cat.shows) {
              if (!show.poster) {
                show.poster = await fetchPoster(show.title);
                saveData();
              }
              const card = createShowCard(
                show.title,
                show.progress,
                show.poster,
              );
              row.appendChild(card);
            }
          }

          const addForm = document.createElement("form");
          addForm.className = "add-show-form";
          addForm.innerHTML = `
      <input type="text" placeholder="Titolo serie..." />
      <input type="text" placeholder="Volte viste (0 = da vedere, lascia vuoto per 1)" />
      <input type="text" placeholder="URL poster (opzionale)" />
      <button type="submit" class="btn btn-secondary">
        <i class="fas fa-plus btn-icon"></i>
        Aggiungi
      </button>
      <span class="drop-hint">Trascina per riordinare</span>
    `;

          addForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const [titleInput, progInput, posterInput] =
              addForm.querySelectorAll("input");
            const titleVal = titleInput.value.trim();
            let progVal = progInput.value.trim();
            if (progVal.includes(",")) progVal = progVal.replace(",", ".");
            if (!titleVal) return;

            const submitBtn = addForm.querySelector("button");
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML =
              '<i class="fas fa-check btn-icon"></i>Aggiunto!';
            submitBtn.disabled = true;

            const matched = progVal.match(/[\d.]+/);
            progVal = matched ? matched[0] : progVal ? progVal : undefined;

            let posterUrl = posterInput.value.trim() || undefined;
            if (!posterUrl) {
              posterUrl = await fetchPoster(titleVal);
            }

            data[index].shows.push({
              title: titleVal,
              progress: progVal || undefined,
              poster: posterUrl || undefined,
            });

            saveData();
            titleInput.value = "";
            progInput.value = "";
            posterInput.value = "";

            setTimeout(() => {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;
            }, 1200);

            await render();
            renumber();
          });

          catEl.appendChild(header);
          catEl.appendChild(row);
          catEl.appendChild(addForm);
          categoriesContainer.appendChild(catEl);
        }
        renumber();
      }

      function renumber() {
        let counter = 1;
        const rows = document.querySelectorAll(".shows-row");
        rows.forEach((row) => {
          const cards = row.querySelectorAll(".show-card");
          if (cards.length) {
            row.classList.remove("empty");
            const emptyMsg = row.querySelector(".empty-msg");
            if (emptyMsg) emptyMsg.remove();
          }
          cards.forEach((card) => {
            const numEl = card.querySelector(".show-number");
            numEl.textContent = counter + ".";
            counter++;
          });
        });
      }

      function addDragHandlers(card) {
        card.addEventListener("dragstart", (e) => {
          dragSrcEl = card;
          card.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
          try {
            e.dataTransfer.setData("text/plain", "drag");
          } catch {}
          card.style.zIndex = "1000";
        });

        card.addEventListener("dragend", () => {
          card.classList.remove("dragging");
          dragSrcEl = null;
          card.style.zIndex = "";
          renumber();
        });
      }

      function addDropHandlers(row) {
        row.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
          const afterElement = getDragAfterElement(row, e.clientX);
          const dragging = document.querySelector(".show-card.dragging");
          if (!dragging) return;

          if (row.classList.contains("empty")) {
            row.classList.remove("empty");
            row.textContent = "";
          }

          row.style.backgroundColor = "rgba(229, 9, 20, 0.05)";
          row.style.borderRadius = "var(--radius)";
          row.style.transition = "background-color 0.2s";

          if (afterElement == null) {
            row.appendChild(dragging);
          } else {
            row.insertBefore(dragging, afterElement);
          }
        });

        row.addEventListener("dragleave", () => {
          row.style.backgroundColor = "";
        });

        row.addEventListener("drop", (e) => {
          e.preventDefault();
          row.style.backgroundColor = "";
          syncDataFromDOM();
          renumber();
        });

        row.addEventListener("dragenter", (e) => {
          e.preventDefault();
        });
      }

      function getDragAfterElement(container, x) {
        const draggableElements = [
          ...container.querySelectorAll(".show-card:not(.dragging)"),
        ];
        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = x - box.left - box.width / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY, element: null },
        ).element;
      }

      let draggedCategory = null;

      function addCategoryDragHandlers(catEl) {
        catEl.addEventListener("dragstart", () => {
          draggedCategory = catEl;
          catEl.classList.add("dragging-category");
        });

        catEl.addEventListener("dragend", () => {
          catEl.classList.remove("dragging-category");
          draggedCategory = null;
          saveData();
        });

        catEl.addEventListener("dragover", (e) => {
          e.preventDefault();
          const container = categoriesContainer;
          const after = getCategoryAfterElement(container, e.clientY);
          if (after == null) {
            container.appendChild(draggedCategory);
          } else {
            container.insertBefore(draggedCategory, after);
          }
        });

        catEl.addEventListener("drop", () => {
          syncCategoriesFromDOM();
          saveData();
        });
      }

      function getCategoryAfterElement(container, y) {
        const elements = [
          ...container.querySelectorAll(".category:not(.dragging-category)"),
        ];
        return elements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY, element: null },
        ).element;
      }

      function syncCategoriesFromDOM() {
        const newData = [];
        const catEls = document.querySelectorAll(".category");
        catEls.forEach((catEl) => {
          const name = catEl
            .querySelector(".category-title")
            .textContent.trim();
          const row = catEl.querySelector(".shows-row");
          const cards = row.querySelectorAll(".show-card");
          const shows = [];
          cards.forEach((card) => {
            const title = card.querySelector(".show-title").textContent.trim();
            const progressEl = card.querySelector(".show-progress");
            const progress = progressEl
              ? progressEl.textContent.match(/[\d.,]+/)?.[0].replace(",", ".")
              : undefined;
            const poster = card.querySelector(".poster")?.src;
            shows.push({ title, progress, poster });
          });
          newData.push({ name, shows });
        });
        data = newData;
      }

      function deleteShow(title) {
        data.forEach((cat) => {
          cat.shows = cat.shows.filter((show) => show.title !== title);
        });
        // Rimuovi dalla cache
        delete showDetailsCache[title];
        saveData();
        render();
      }

      function syncDataFromDOM() {
        const newData = [];
        const categoryEls = document.querySelectorAll(".category");
        categoryEls.forEach((catEl) => {
          const name = catEl.querySelector(".category-title").textContent;
          const row = catEl.querySelector(".shows-row");
          const cards = row.querySelectorAll(".show-card");
          const shows = [];
          cards.forEach((card) => {
            const title = card.querySelector(".show-title").textContent;
            const progressEl = card.querySelector(".show-progress");
            const progress = progressEl
              ? progressEl.textContent.match(/[\d.,]+/)?.[0].replace(",", ".")
              : undefined;
            const originalShow = data
              .flatMap((cat) => cat.shows)
              .find((s) => s.title === title);
            shows.push({
              title,
              progress,
              poster:
                originalShow?.poster || card.querySelector(".poster")?.src,
            });
          });
          newData.push({ name, shows });
        });
        data.length = 0;
        newData.forEach((c) => data.push(c));
        saveData();
      }

      document
        .getElementById("addCategoryForm")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const input = document.getElementById("newCategoryName");
          const name = input.value.trim();
          if (!name) return;
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML =
            '<i class="fas fa-check btn-icon"></i>Aggiunta!';
          setTimeout(() => {
            submitBtn.innerHTML = originalText;
          }, 1500);
          data.push({ name, shows: [] });
          input.value = "";
          render();
        });

      function generatePrintableList() {
        let output = "";
        let counter = 1;
        const categoryEls = document.querySelectorAll(".category");
        categoryEls.forEach((catEl) => {
          const catName = catEl
            .querySelector(".category-title")
            .textContent.trim();
          const cards = catEl.querySelectorAll(".show-card");
          output += `${catName}\n${"=".repeat(catName.length)}\n\n`;
          cards.forEach((card) => {
            const title = card.querySelector(".show-title").textContent.trim();
            const progressEl = card.querySelector(".show-progress");
            const progress = progressEl
              ? progressEl.textContent.match(/[\d.,]+/)?.[0] || ""
              : "";
            const progText = progress
              ? ` — ${progress} volte`
              : progressEl && progressEl.textContent.includes("Da vedere")
                ? " — Da vedere"
                : "";
            output += `${counter}. ${title}${progText}\n`;
            counter++;
          });
          output += "\n\n";
        });
        return output.trim();
      }

      document.getElementById("printListBtn").addEventListener("click", () => {
        const text = generatePrintableList();
        showPrintablePopup(text);
      });

      function showPrintablePopup(text) {
        const popup = document.createElement("div");
        popup.className = "print-popup";
        popup.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.9);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    padding: 20px;
    animation: fadeIn 0.3s ease;
  `;

        const box = document.createElement("div");
        box.style.cssText = `
    background: #111;
    padding: 25px;
    border-radius: var(--radius);
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    color: #fff;
    font-family: 'Monaco', 'Courier New', monospace;
    white-space: pre-wrap;
    line-height: 1.6;
    border: 1px solid #333;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  `;

        const header = document.createElement("div");
        header.style.cssText = `
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #333;
  `;

        const title = document.createElement("h3");
        title.textContent = "Lista Serie TV";
        title.style.cssText = `
    margin: 0;
    color: var(--accent);
    font-size: 18px;
  `;

        const buttonGroup = document.createElement("div");
        buttonGroup.style.cssText = ` display: flex; gap: 10px; `;

        const closeBtn = document.createElement("button");
        closeBtn.className = "btn btn-secondary";
        closeBtn.textContent = "Chiudi";
        closeBtn.onclick = () => {
          popup.style.animation = "fadeOut 0.3s ease";
          setTimeout(() => popup.remove(), 300);
        };

        const copyBtn = document.createElement("button");
        copyBtn.className = "btn btn-primary";
        copyBtn.textContent = "Copia";
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(text);
          copyBtn.innerHTML = '<i class="fas fa-check"></i> Copiato!';
          copyBtn.disabled = true;
          setTimeout(() => {
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copia';
            copyBtn.disabled = false;
          }, 2000);
        };

        const content = document.createElement("div");
        content.textContent = text;
        content.style.cssText = `
    padding: 15px;
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    font-size: 13px;
  `;

        buttonGroup.appendChild(copyBtn);
        buttonGroup.appendChild(closeBtn);
        header.appendChild(title);
        header.appendChild(buttonGroup);
        box.appendChild(header);
        box.appendChild(content);
        popup.appendChild(box);
        document.body.appendChild(popup);

        const style = document.createElement("style");
        style.textContent = `
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
  `;
        document.head.appendChild(style);
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/"/g, "&quot;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      // ---------------- ESECUZIONE INIZIALE ----------------
      (async () => {
        await initData();
        await render();
      })();
    </script>
  </body>
</html>
